---
title:  "í™ˆì„œë²„ë¡œ ë©”ì¼ ì„œë²„ êµ¬ì¶•(1) - Ubuntu + Squarespace + certbot + postfix + dovecot"
categories: 
  - archiving
tags:
  - homeserver
toc: true
toc_sticky: true
---

## ë©”ì¼ ì„œë²„ë¥¼ êµ¬ì¶•í•´ë´…ì‹œë‹¤ âœ‰ï¸

í™ˆì„œë²„ë„ ìˆê³ , ë„ë©”ì¸ë„ ìˆê³ , ì›¹í˜ì´ì§€ë„ í˜¸ìŠ¤íŒ… í•˜ê³  ìˆìœ¼ë‹ˆ ë‹¤ìŒìœ¼ë¡œ í•´ë³¼ ê²ƒì€ ë©”ì¼ ì„œë²„ì…ë‹ˆë‹¤!

ìš”ì¦˜ì—ëŠ” êµ¬ê¸€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ë¥¼ ì´ìš©í•´ì„œ ê³„ì •ì„ ìƒì„±í•˜ê³¤ í•˜ëŠ”ë°ìš”, ì´ ê²½ìš°ê°€ ê´€ë¦¬ë„ ì‰½ê³  êµ¬ê¸€ì—ì„œ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ë“¤ë„ ëˆ„ë¦´ ìˆ˜ ìˆì–´ì„œ ì‚¬ì‹¤ ì¢€ ë” ë§ì´ í¸í•˜ê¸´ í•©ë‹ˆë‹¤.

í•˜ì§€ë§Œ, ì„œë²„ì™€ ë„¤íŠ¸ì›Œí¬ë¥¼ ê³µë¶€í•˜ê¸° ìœ„í•´ì„  ì§ì ‘ ì „ë¶€ í•´ë³´ëŠ” ê²½í—˜ì´ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í–ˆì–´ìš”.

ê·¸ë¦¬ê³  ì•„ì§ì€ í•´ë‹¹ ë©”ì¼ì„ ì—…ë¬´ìš©ìœ¼ë¡œ ì‚¬ìš©í•˜ì§„ ì•Šì„ ê³„íšì´ì—ˆìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ ì§ì ‘ ì„œë²„ë¥¼ êµ¬ì¶•í•˜ê³  ì¸ì¦ì„œë¥¼ ë°œê¸‰í•˜ê³ , DNS ë ˆì½”ë“œë¥¼ ì—°ê²°í•´ë³´ê³ , ëª¨ë“  ë³´ì•ˆ ê³¼ì •ì„ ìˆ˜í–‰í•´ë³´ì•˜ìŠµë‹ˆë‹¤.

~~ì‚¬ì‹¤ ê°€ë‚œí•œ ëŒ€í•™ìƒì¸ ì €ì—ê² êµ¬ê¸€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì›”ì •ì•¡ì´ ë¹„ìŒŒìŠµë‹ˆë‹¤ 1ë…„ì—... 10ë§Œì› ì •ë„...~~

ì´ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ì„œë²„ êµ¬ì¶•, ì¸ì¦ì„œ ë°œê¸‰, ê·¸ì— ë”°ë¥¸ DNS ë ˆì½”ë“œ ì—°ê²°ê¹Œì§€ ì‘ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.

ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œ ë©”ì¼ ë³´ì•ˆ ê³¼ì •ì„ ì‘ì„±í•´ë‘˜ê²Œìš”!

## ì„ ìˆ˜ ì§€ì‹ ğŸ§

ë©”ì¼ ì„œë²„ë¥¼ êµ¬ì¶•í•˜ê¸° ì „ì—, ë©”ì¼ ì„œë²„ê°€ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì‘ë™í•˜ëŠ”ì§€ ì•Œì•„ë´…ì‹œë‹¤ :) 

ì‚¬ì‹¤ ì´ ë‚´ìš©ì€ ì •ë§ ë§ì€ ë¶„ë“¤ì´ ìì„¸íˆ ì ì–´ë‘ì…¨ë”ë¼êµ¬ìš”.

ì €ëŠ” **ë¦¬ëˆ…ìŠ¤ ì„œë²„ ë³´ì•ˆ (ë‚˜ì¹´ì§€ë§ˆ ìš”ì‹œì¹´ì¦ˆ)**ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì—¬ëŸ¬ ìë£Œë“¤ì„ ì°¸ê³ í•´ì„œ ì‘ì„±í•´ë³´ê² ìŠµë‹ˆë‹¤.

### 1. ì†Œí”„íŠ¸ì›¨ì–´

1) MUA(Mail User Agent)

    - ë©”ì¼ í´ë¼ì´ì–¸íŠ¸ ì†Œí”„íŠ¸ì›¨ì–´
    - ë©”ì¼ ë°•ìŠ¤ì— ë„ì°©í•œ ë©”ì¼ì„ MUAë¥¼ í†µí•´ ì—´ì–´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

2) MTA(Message Transfer Agent)

    - ì¼ë°˜ì ìœ¼ë¡œ ë©”ì¼ ì„œë²„ë¼ê³  ë¶ˆë¦¬ëŠ” ì†Œí”„íŠ¸ì›¨ì–´
    - MUAì—ì„œ ì‘ì„±í•œ ë©”ì¼ì„ ë°›ê³ , ì‚¬ìš©ìì˜ ë©”ì¼í•¨ì— ë©”ì¼ì„ ì „ì†¡í•©ë‹ˆë‹¤.
    - SMTP í”„ë¡œí† ì½œì„ ì´ìš©í•˜ì—¬, SMTP ì„œë²„ë¼ê³  ë¶ˆë¦¬ê¸°ë„ í•©ë‹ˆë‹¤.

3) MDA(Mail Delivery Agent) 
    - MTAê°€ MUAë¥¼ í†µí•´ ë°›ì€ ë©”ì¼ì„ ì‚¬ìš©ìì˜ ë©”ì¼í•¨ì— ì „ì†¡í•˜ëŠ” ì†Œí”„íŠ¸ì›¨ì–´
    - ë¡œì»¬ ì „ì†¡ í”„ë¡œê·¸ë¨

### 2. í”„ë¡œí† ì½œ

ë©”ì¼ê³¼ ê´€ë ¨ëœ í”„ë¡œí† ì½œì€ ì´ 3ê°€ì§€ê°€ ìˆìŠµë‹ˆë‹¤.

1) SMTP(Simple Mail Transfer Protocol)

    - 25ë²ˆ í¬íŠ¸ ì‚¬ìš©
        - TLS ì•”í˜¸í™”ë¥¼ ì‚¬ìš©í•œ ê²½ìš° 587ë²ˆ í¬íŠ¸ ì‚¬ìš©
    - MUA -> MTA / MTA(ì†¡ì‹ ) -> MTA(ìˆ˜ì‹ )ì˜ ê²½ìš° ì‚¬ìš©ë˜ëŠ” í”„ë¡œí† ì½œì…ë‹ˆë‹¤.

2) POP3(Post Office Protocol ver 3)

    - 110ë²ˆ í¬íŠ¸ ì‚¬ìš© 
        - SSL ì•”í˜¸í™”ë¥¼ ì‚¬ìš©í•œ ê²½ìš° 995ë²ˆ í¬íŠ¸ ì‚¬ìš©
    - ë©”ì¼í•¨ -> MUA(ìˆ˜ì‹ )ì˜ ê²½ìš° ì‚¬ìš©ë˜ëŠ” í”„ë¡œí† ì½œì…ë‹ˆë‹¤.
    - ë©”ì¼ì„ ë¡œì»¬ì— ë‹¤ìš´ë¡œë“œí•˜ê³ , ì„œë²„ì—ì„œ ì‚­ì œí•©ë‹ˆë‹¤.

3) IMAP(Internet Message Access Protocol)

    - 143ë²ˆ í¬íŠ¸ ì‚¬ìš©
        - SSL ì•”í˜¸í™”ë¥¼ ì‚¬ìš©í•œ ê²½ìš° 993ë²ˆ í¬íŠ¸ ì‚¬ìš©
    - ë©”ì¼í•¨ -> MUA(ìˆ˜ì‹ )ì˜ ê²½ìš° ì‚¬ìš©ë˜ëŠ” í”„ë¡œí† ì½œì…ë‹ˆë‹¤.
        - POP3ì™€ ì—­í• ì´ ê°™ìŠµë‹ˆë‹¤.
    - ë©”ì¼ì„ ë¡œì»¬ì— ë‹¤ìš´ë¡œë“œí•˜ì§€ ì•Šê³ , ë©”ì¼ ì„œë²„ì— ë‘” ì±„ë¡œ ì‘ì—…í•©ë‹ˆë‹¤.
        - ë”°ë¼ì„œ, ì—¬ëŸ¬ ê¸°ê¸°ì—ì„œ ë™ì¼í•œ ë©”ì¼í•¨ ìƒíƒœë¥¼ ìœ ì§€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë©”ì¼ ì†¡ìˆ˜ì‹  ê³¼ì •ì„ ê·¸ë¦¼ìœ¼ë¡œ ê·¸ë¦¬ë©´ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

<img src="/assets/images/mail_server_structure.jpeg" alt="mail_server_structure" width="98%">
<br>

ì‚¬ìš©ìê°€ ë©”ì¼ì„ MUAë¥¼ í†µí•´ ì‘ì„±í•˜ë©´ í•´ë‹¹ ë©”ì¼ì„ MTAê°€ ë°›ê³ , DNS ì„œë²„ì—ì„œ MX ë ˆì½”ë“œë¥¼ ì°¸ì¡°í•˜ì—¬ ë©”ì¼ì„ ë³´ë‚¼ ì„œë²„ì˜ MTAë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

ì´í›„, MTA(ì†¡ì‹ )ëŠ” MTA(ìˆ˜ì‹ )ì— ë©”ì¼ì„ ì „ì†¡í•˜ê³  MTA(ìˆ˜ì‹ )ì€ MDAë¥¼ í†µí•´ ë©”ì¼í•¨ì— ë©”ì¼ì„ ì „ì†¡í•©ë‹ˆë‹¤.

ìµœì¢…ì ìœ¼ë¡œ POP/IMAP ì„œë²„ë¥¼ í†µí•´ ë©”ì¼í•¨ìœ¼ë¡œë¶€í„° ë©”ì¼ì„ ë°›ìŠµë‹ˆë‹¤.

## ë©”ì¼ ì„œë²„ êµ¬ì¶•í•˜ê¸° ğŸ“¬

### 0. í™˜ê²½ âš™ï¸ 

ê·¸ëŸ¼ ì´ì œ í™˜ê²½ì„ êµ¬ì„±í•´ë´…ì‹œë‹¤!

ìš°ì„ , ì œê°€ ì„ íƒí•œ ë„ë©”ì¸ ë“±ë¡ ê¸°ê´€ì€ **Squarespace** ì…ë‹ˆë‹¤.

ì›ë˜ êµ¬ê¸€ ë„ë©”ì¸ì„ ì‚¬ìš©í•˜ë ¤ê³  í–ˆì—ˆëŠ”ë°, Squarespaceê°€ êµ¬ê¸€ ë„ë©”ì¸ì„ ì¸ìˆ˜í•˜ë©´ì„œ Squarespaceê°€ êµ¬ê¸€ ë„ë©”ì¸ì—ì„œ ê´€ë¦¬í•˜ëŠ” ë„ë©”ì¸ì˜ ë“±ë¡ê¸°ê´€ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.

ê·¸ë˜ì„œ êµ¬ê¸€ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ë“±ì˜ êµ¬ê¸€ì—ì„œ ì œê³µí•˜ëŠ” ì„œë¹„ìŠ¤ë“¤ê³¼ ì—°ê²°í•˜ê¸° ìš©ì´í•˜ê²Œ êµ¬ì„±ë˜ì–´ ìˆì–´ìš”.

ê·¸ëŸ°ë° ë¬¸ì œëŠ” êµ­ë‚´ì—ì„œ Squarespaceë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° DNS ë ˆì½”ë“œë¥¼ ë“±ë¡í•˜ëŠ” ë“±ì˜ ë„ë©”ì¸ ê´€ë¦¬ ê´€ë ¨ íŠœí† ë¦¬ì–¼ì´ ì ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

Squarespaceê°€ ë„ë©”ì¸ ë“±ë¡ë„ ê°€ëŠ¥í•˜ì§€ë§Œ, ì›¹ì‚¬ì´íŠ¸ êµ¬ì¶• ë° í˜¸ìŠ¤íŒ…ì´ ì£¼ë ¥ì¸ ì„œë¹„ìŠ¤ë¼ ì›¹ì‚¬ì´íŠ¸ êµ¬ì¶• ê´€ë ¨ìœ¼ë¡œ íŠœí† ë¦¬ì–¼ì´ ë§ë”ë¼ê³ ìš”.

ê·¸ë˜ì„œ, Squarespaceì—ì„œ ì–´ë–»ê²Œ ë ˆì½”ë“œë¥¼ êµ¬ì„±í•´ì•¼ í•˜ëŠ”ì§€ë„ ì¶”ê°€í•´ì„œ ì ì„ ì˜ˆì •ì…ë‹ˆë‹¤!

ê·¸ë¦¬ê³ , SSL/TLS ì¸ì¦ì„œëŠ” certbotì„ í†µí•´ ë°œê¸‰ ë°›ì„ ê±°ì—ìš”.

MTAë¡œëŠ” posfix, POP3/IMAP ì„œë²„ë¡œëŠ” Dovecotì„ ì‚¬ìš©í•´ì¤„ê²ë‹ˆë‹¤!

MUAëŠ” ì·¨í–¥ê» ê³ ë¥´ì‹œë©´ ë˜ëŠ”ë°ìš”, ì €ëŠ” Thunderbirdë¥¼ ì‚¬ìš©í–ˆì–´ìš”. ë§ì€ ì‚¬ëŒë“¤ì´ ì‚¬ìš©í•˜ëŠ” ê²ƒ ê°™ë”ë¼ê³ ìš”.

{: .notice--info}
> **ì‚¬ìš©í•˜ëŠ” ë²„ì „** <br>
> certbot 2.9.0 <br>
> postfix 3.8.6 <br>
> dovecot 2.3.21

ì, ê·¸ëŸ¬ë©´ ì´ì œ ê³µìœ ê¸° í¬íŠ¸í¬ì›Œë”©ì„ í•´ì¤ì‹œë‹¤!

<img src="/assets/images/mail_portforwarding.png" alt="mail_portforwarding" width="98%">
<br>

ì‚¬ì‹¤ ì €ëŠ” ê·œì¹™ëª…ì„ ì˜ëª» ì ì—ˆì–´ìš”...

993ë²ˆê³¼ 995ë²ˆì€ ë°˜ëŒ€ë¡œ ì ì–´ì•¼ í•©ë‹ˆë‹¤.

ë‹¤ë¥¸ íŠœí† ë¦¬ì–¼ ë³´ê³  í¬íŠ¸í¬ì›Œë”© í•´ì¤¬ëŠ”ë°, ê³µë¶€í•´ë³´ë‹ˆ ë°˜ëŒ€ë”ë¼ê³ ìš”.

ê·¼ë° ì‚¬ì‹¤ í° ì˜í–¥ì€ ì—†ì–´ì„œ ê´œì°®ìŠµë‹ˆë‹¤. ê·¸ëƒ¥ ë³„ëª… ê°™ì€ ê±°ì—¬ì„œìš”.

ì•„ë¬´íŠ¼, pop3sê°€ 995ë²ˆ imapsê°€ 993ë²ˆì…ë‹ˆë‹¤!

| í”„ë¡œí† ì½œ | í¬íŠ¸ | ì„¤ëª…            |
|----------|------|-----------------|
| SMTP     | 587  | ë©”ì¼ ë°œì‹  (STARTTLS) |
| IMAPS    | 993  | IMAP over SSL   |
| POP3S    | 995  | POP3 over SSL   |

ê·¸ë¦¬ê³  ì„œë²„ì—ì„œ ë°©í™”ë²½ë„ ì—´ì–´ì¤ì‹œë‹¤.

ì € í¬íŠ¸ë“¤ ë‹¤ ì—´ì–´ì£¼ë©´ ë©ë‹ˆë‹¤.

```
sudo ufw allow 587/tcp
```

ì´ëŸ° ì‹ìœ¼ë¡œ ì—´ì–´ì£¼ë©´ ë©ë‹ˆë‹¤.

ê·¸ë¦¬ê³ , ë„ë©”ì¸ ë“±ë¡ ê¸°ê´€ì— ì ‘ì†í•´ì„œ DNS ë ˆì½”ë“œë¥¼ ì„¤ì •í•´ì¤ë‹ˆë‹¤.

í˜„ì¬ ë‹¨ê³„ì—ì„œëŠ” 3ê°œì˜ ë ˆì½”ë“œë¥¼ ì¶”ê°€í•˜ë©´ ë©ë‹ˆë‹¤.

| Host      | Type    |Priority     |TTL          |Data             |
|-----------|---------|-------------|-------------|-----------------|
| @         | MX      | 10          | 4 hrs       |mail.[yourdomain]|
| mail      | A       | N/A         | 4 hrs       |[ê³µì¸ IP]         |

ìœ„ì˜ MX ë ˆì½”ë“œëŠ” mail.[yourdomain]ì„ ì œê°€ êµ¬ë§¤í•œ ë„ë©”ì¸ì˜ ë©”ì¼ ì„œë²„ë¡œ ì§€ì •í•´ì£¼ëŠ” ì„¤ì •ì´ê³ , A ë ˆì½”ë“œëŠ” mail.[yourdomain]ì´ ì„œë²„ì˜ ê³µì¸ IPë¥¼ ê°€ë¦¬í‚¤ë„ë¡ í•˜ëŠ” ì„¤ì •ì…ë‹ˆë‹¤.

ì •ë¦¬í•˜ë©´, mail.[yourdomain] ì„œë²„ë¡œ ë©”ì¼ì„ ë°›ê³ , ì´ ë„ë©”ì¸ì€ ì œ ê³µì¸ IPë¥¼ ê°€ë¦¬í‚¤ê²Œë©ë‹ˆë‹¤.

### 1. etc/hosts ì„¤ì • ğŸ¤“

/etc/hostname ìˆ˜ì •

```
mail
```

/etc/hosts ìˆ˜ì •
```
127.0.0.1 localhost
127.0.1.1   mail.swlee.net mail # ì´ ì¤„ì„ ì¶”ê°€

# The following lines are desirable for IPv6 capable hosts
::1     ip6-localhost ip6-loopback
fe00::0 ip6-localnet
ff00::0 ip6-mcastprefix
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

ì´ë ‡ê²Œ í•˜ë©´ sewon@mailì´ ë˜ë˜ë° ì´ê±° ì‚¬ì‹¤ ì•ˆí•´ë„ ë˜ëŠ” ê²ƒ ê°™ê¸´ í•˜ì§€ë§Œ ì¼ë‹¨ ì €ë ‡ê²Œ í–ˆë”ë‹ˆ êµ´ëŸ¬ê°€ì„œ ëƒ…ë‘ëŠ” ì¤‘ì…ë‹ˆë‹¤.

ìˆ˜ì • ì•ˆí•´ë„ ì‘ë™í•˜ëŠ”ì§€ëŠ” í™•ì¸ì„ í•œ ë²ˆ í•´ë´ì•¼ í•  ê²ƒ ê°™ì•„ìš”.

íŠœí† ë¦¬ì–¼ ë”°ë¼í•œê±°ë¼ ì¼ë‹¨ ë‚˜ì¤‘ì— í•œ ë²ˆ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

### 2. Postfix ì„¤ì • ğŸ“¨

postfixë¥¼ ê¹”ì•„ì¤ë‹ˆë‹¤.

```
sudo apt install postfix
```

ì„¤ì¹˜í•˜ê²Œ ë˜ë©´ êµ¬ì„± ë§ˆë²•ì‚¬ê°€ ë“±ì¥í•˜ëŠ”ë° ì•„ë˜ì™€ ê°™ì´ ì…ë ¥í•´ì¤ë‹ˆë‹¤.

>General type of mail configuration: Internet Site ì„ íƒ
>System mail name: ë©”ì¼ ì„œë²„ì˜ ë„ë©”ì¸ ì´ë¦„ ì…ë ¥ (ì˜ˆ: [yordomain].com)

ê·¸ë¦¬ê³ , ì €ëŠ” ì €ë²ˆì— https ì„¤ì •í•˜ë©´ì„œ ë°œê¸‰ ë°›ì•˜ë˜ ì¸ì¦ì„œê°€ ìˆì–´ì„œ í•´ë‹¹ ì¸ì¦ì„œë¡œ SSL/TSL ì¸ì¦ì„ í•´ì¤„ê²ë‹ˆë‹¤.

ì´ì œ postfix êµ¬ì„± íŒŒì¼ì„ ìˆ˜ì •í•´ë´…ì‹œë‹¤.

ì•ìœ¼ë¡œ ëª¨ë“  êµ¬ì„± íŒŒì¼ì€ ì „ë¬¸ì„ ì¶”ê°€í•´ë‘˜ ì˜ˆì •ì…ë‹ˆë‹¤.

ì œê°€ íŠœí† ë¦¬ì–¼ì„ ë³´ë©´ì„œ ê°€ì¥ í—·ê°ˆë ¸ë˜ ë¶€ë¶„ì´ ìˆ˜ì •ì„ í•´ì•¼í•˜ëŠ” ë¶€ë¶„ì„ ì°¾ëŠ” ê²ƒì´ì—ˆëŠ”ë°ìš”, ì „ë¬¸ì„ ì¶”ê°€í•˜ê²Œ ë˜ë©´ ìˆ˜ì • ìœ„ì¹˜ë¥¼ ì°¾ëŠ” ê²ƒì´ ë”ìš± í¸ë¦¬í•  ê²ƒ ê°™ì•„ì„œ ê°€ë…ì„±ì€ ì¡°ê¸ˆ ë–¨ì–´ì§€ë”ë¼ë„ íŒŒì¼ ì „ë¬¸ì„ ë„£ì–´ë‘ê² ìŠµë‹ˆë‹¤.

ì „ë¬¸ì„ ë„£ê¸°ì—ëŠ” ì£¼ì„ì´ ë„ˆë¬´ ë§ì€ ê²½ìš°ëŠ” ë¼ì¸ ë²ˆí˜¸ë¥¼ ê¸°ì…í•´ë‘ê² ìŠµë‹ˆë‹¤.

`sudo vi /etc/postfix/main.cf`ë¡œ í¸ì§‘í•´ì¤ì‹œë‹¤.

```
# See /usr/share/postfix/main.cf.dist for a commented, more complete version


# Debian specific:  Specifying a file name will cause the first
# line of that file to be used as the name.  The Debian default
# is /etc/mailname.
#myorigin = /etc/mailname

smtpd_banner = $myhostname ESMTP $mail_name (Ubuntu)
biff = no

# appending .domain is the MUA's job.
append_dot_mydomain = no

# Uncomment the next line to generate "delayed mail" warnings
#delay_warning_time = 4h

readme_directory = no

# See http://www.postfix.org/COMPATIBILITY_README.html -- default to 3.6 on
# fresh installs.
compatibility_level = 3.6

# TLS parameters
#smtpd_tls_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
#smtpd_tls_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
smtpd_tls_security_level=may

#smtp_tls_CApath=/etc/ssl/certs
smtp_tls_security_level=may
smtp_tls_session_cache_database = btree:${data_directory}/smtp_scache
smtpd_tls_session_cache_database = btree:${data_directory}/smtpd_scache

smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination
# host & domain í˜¸ìŠ¤íŠ¸ ë° ë„ë©”ì¸ ì„¤ì •
myhostname = mail.[yourdomain]
mydomain = [yourdomain]
alias_maps = hash:/etc/aliases
alias_database = hash:/etc/aliases
myorigin = $mydomain

# mail reception domain ë©”ì¼ ìˆ˜ì‹  ë„ë©”ì¸ ì„¤ì •
mydestination = $myhostname, localhost.$mydomain, localhost, $mydomain
relayhost =

# ì‹ ë¢°í•  ìˆ˜ ìˆëŠ” network
mynetworks = 127.0.0.0/8

#[::ffff:127.0.0.0]/104 [::1]/128

# mailbox í™ˆ ë””ë ‰í† ë¦¬ ë©”ì¼í•¨ ì‚¬ìš©
home_mailbox = Maildir/

mailbox_size_limit = 0
recipient_delimiter = +

# network
inet_interfaces = all
inet_protocols = all

# STMP ì„¤ì •
smtpd_sasl_type = dovecot
smtpd_sasl_path = private/auth
smtpd_sasl_auth_enable = yes

# TLS ì„¤ì •
# ì¸ì¦ì„œ ê²½ë¡œ
smtpd_tls_cert_file = /etc/letsencrypt/live/[yourdomain]/fullchain.pem
smtpd_tls_key_file = /etc/letsencrypt/live/[yourdomain]/privkey.pem
smtpd_use_tls = yes
smtpd_tls_auth_only = yes

# ìˆ˜ì‹  ì œí•œ (ì¸ì¦ëœ ì‚¬ìš©ìë§Œ ë©”ì¼ ë°œì†¡ ê°€ëŠ¥)
smtpd_recipient_restrictions = permit_sasl_authenticated, reject_unauth_destination
```

ì´ë ‡ê²Œ ì„¤ì •í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

**ëŒ€ì‹  ì´ ë•Œ ê¼­ ì£¼ì˜í•´ì•¼í•  ì ì´ ì£¼ì„ì„ ì˜†ì— ì ìœ¼ì‹œë©´ ì˜¤ë¥˜ê°€ ë°œìƒí•´ ì œëŒ€ë¡œ ì¸ì‹í•˜ì§€ ëª»í•©ë‹ˆë‹¤!!**

ê·¸ëŸ¬ë‹ˆ ì£¼ì„ì€ ê¼­ ìœ„ì— ì ì–´ì£¼ì„¸ìš”.

ë‹¤ìŒìœ¼ë¡œëŠ” `sudo vi /etc/postfix/master.cf` ë¥¼ ìˆ˜ì •í•´ë´…ì‹œë‹¤.

ì•„ë˜ ì½”ë“œë¥¼ ë³´ì‹œê³ , ì£¼ì„ í•´ì œë¥¼ ì‹œì¼œì£¼ë©´ ë©ë‹ˆë‹¤.
```
#
# Postfix master process configuration file.  For details on the format
# of the file, see the master(5) manual page (command: "man 5 master" or
# on-line: http://www.postfix.org/master.5.html).
#
# Do not forget to execute "postfix reload" after editing this file.
#
# ==========================================================================
# service type  private unpriv  chroot  wakeup  maxproc command + args
#               (yes)   (yes)   (no)    (never) (100)   
# ==========================================================================
smtp      inet  n       -       y       -       -       smtpd
#smtp      inet  n       -       y       -       1       postscreen
#smtpd     pass  -       -       y       -       -       smtpd
#dnsblog   unix  -       -       y       -       0       dnsblog
#tlsproxy  unix  -       -       y       -       0       tlsproxy
# Choose one: enable submission for loopback clients only, or for any client.
#127.0.0.1:submission inet n -   y       -       -       smtpd
submission inet n       -       y       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=encrypt
  -o smtpd_sasl_auth_enable=yes
#  -o smtpd_tls_auth_only=yes
#  -o local_header_rewrite_clients=static:all
#  -o smtpd_reject_unlisted_recipient=no
#     Instead of specifying complex smtpd_<xxx>_restrictions here,
#     specify "smtpd_<xxx>_restrictions=$mua_<xxx>_restrictions"
#     here, and specify mua_<xxx>_restrictions in main.cf (where
#     "<xxx>" is "client", "helo", "sender", "relay", or "recipient").
#  -o smtpd_client_restrictions=
#  -o smtpd_helo_restrictions=
#  -o smtpd_sender_restrictions=
#  -o smtpd_relay_restrictions=
  -o smtpd_recipient_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING
# Choose one: enable submissions for loopback clients only, or for any client.
#127.0.0.1:submissions inet n  -       y       -       -       smtpd
submissions     inet  n       -       y       -       -       smtpd
  -o syslog_name=postfix/submissions
  -o smtpd_tls_wrappermode=yes
  -o smtpd_sasl_auth_enable=yes
#  -o local_header_rewrite_clients=static:all
#  -o smtpd_reject_unlisted_recipient=no
#     Instead of specifying complex smtpd_<xxx>_restrictions here,
#     specify "smtpd_<xxx>_restrictions=$mua_<xxx>_restrictions"
#     here, and specify mua_<xxx>_restrictions in main.cf (where
#     "<xxx>" is "client", "helo", "sender", "relay", or "recipient").
#  -o smtpd_client_restrictions=
#  -o smtpd_helo_restrictions=
#  -o smtpd_sender_restrictions=
#  -o smtpd_relay_restrictions=
  -o smtpd_recipient_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING
```

ì„¤ì •ì´ ëë‚¬ë‹¤ë©´, `systemctl restart postfix`ë¡œ ì¬ì‹¤í–‰ ì‹œì¼œì¤ë‹ˆë‹¤.

### 3. Dovecot ì„¤ì • ğŸ“¬

Dovecotì€ SMTP ì¸ì¦ì„ ì²˜ë¦¬í•˜ê³ , POP3/IMAP í”„ë¡œí† ì½œì„ í†µí•œ ë©”ì¼ ìˆ˜ì‹  ê¸°ëŠ¥ì„ ë‹´ë‹¹í•©ë‹ˆë‹¤.

dovecotì„ ì„¤ì¹˜í•´ì¤ì‹œë‹¤.

```
sudo apt install dovecot-core dovecot-imapd dovecot-pop3d
```

ì„¤ì •ì„ ì‹œì‘í•´ë´…ì‹œë‹¤.

`sudo vi /etc/dovecot/conf.d/10-master.conf ` ì„¤ì • íŒŒì¼ë¶€í„° ìˆ˜ì •í•´ë´…ì‹œë‹¤!

```
#default_process_limit = 100
#default_client_limit = 1000

# Default VSZ (virtual memory size) limit for service processes. This is mainly
# intended to catch and kill processes that leak memory before they eat up
# everything.
#default_vsz_limit = 256M

# Login user is internally used by login processes. This is the most untrusted
# user in Dovecot system. It shouldn't have access to anything at all.
#default_login_user = dovenull
    
# Internal user is used by unprivileged processes. It should be separate from
# login user, so that login processes can't disturb other processes.
#default_internal_user = dovecot

# í¬íŠ¸ í™œì„±í™”    
service imap-login {
  inet_listener imap {
    port = 143
  }
  inet_listener imaps {
    port = 993
    ssl = yes
  }
  
  # Number of connections to handle before starting a new process. Typically
  # the only useful values are 0 (unlimited) or 1. 1 is more secure, but 0
  # is faster. <doc/wiki/LoginProcess.txt>
  #service_count = 1
  
  # Number of processes to always keep waiting for more connections.
  #process_min_avail = 0
    
  # If you set service_count=0, you probably need to grow this.
  #vsz_limit = $default_vsz_limit
}   
    
service pop3-login {
  inet_listener pop3 {
    #port = 110
  }
  inet_listener pop3s {
    #port = 995
    #ssl = yes
  }
}   

service submission-login {
  inet_listener submission {
    #port = 587
  }
  inet_listener submissions {
    #port = 465
  }
}   

service lmtp {
  unix_listener lmtp {
    #mode = 0666
  }

  # Create inet listener only if you can't use the above UNIX socket
  #inet_listener lmtp {
    # Avoid making LMTP visible for the entire internet
    #address =
    #port = 
  #}
}

service imap {
  # Most of the memory goes to mmap()ing files. You may need to increase this
  # limit if you have huge mailboxes.
  #vsz_limit = $default_vsz_limit

  # Max. number of IMAP processes (connections)
  #process_limit = 1024
}

service pop3 {
  # Max. number of POP3 processes (connections)
  #process_limit = 1024
}

service submission {
  # Max. number of SMTP Submission processes (connections)
  #process_limit = 1024
} 

service auth {
  # auth_socket_path points to this userdb socket by default. It's typically
  # used by dovecot-lda, doveadm, possibly imap process, etc. Users that have
  # full permissions to this socket are able to get a list of all usernames and
  # get the results of everyone's userdb lookups.
  #
  # The default 0666 mode allows anyone to connect to the socket, but the
  # userdb lookups will succeed only if the userdb returns an "uid" field that
  # matches the caller process's UID. Also if caller's uid or gid matches the
  # socket's uid or gid the lookup succeeds. Anything else causes a failure.
  #
  # To give the caller full permissions to lookup all users, set the mode to
  # something else than 0666 and Dovecot lets the kernel enforce the
  # permissions (e.g. 0777 allows everyone full permissions).
  #unix_listener auth-userdb {
   # mode = 0666
   # user = 
   # group = 
  #}

  # ì—¬ê¸°ë¥¼ ìˆ˜ì •í•´ì¤ë‹ˆë‹¤.
  # Postfix smtp-auth
  unix_listener /var/spool/postfix/private/auth {
    mode = 0660
    user = postfix
    group = postfix
  } 
    
  # Auth process is run as this user.
  #user = $default_internal_user
}   
  
service auth-worker {
  # Auth worker process is run as root by default, so that it can access
  # /etc/shadow. If this isn't necessary, the user should be changed to
  # $default_internal_user.
  #user = root
} 

service dict {
  # If dict proxy is used, mail processes should have access to its socket.
  # For example: mode=0660, group=vmail and global mail_access_groups=vmail
  unix_listener dict {
    #mode = 0600
    #user = 
    #group = 
  }
} 
```

`sudo vi /etc/dovecot/conf.d/10-auth.conf` ì´ë²ˆì—ëŠ” ì¸ì¦ë°©ë²• ì„¤ì • íŒŒì¼ì„ ìˆ˜ì •í•´ë´…ì‹œë‹¤.

í•œê¸€ ì£¼ì„ì´ ë‹¬ë ¤ ìˆëŠ” ë¶€ë¶„ë§Œ ìˆ˜ì •í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤.

```
##
## Authentication processes
##

# Disable LOGIN command and all other plaintext authentications unless
# SSL/TLS is used (LOGINDISABLED capability). Note that if the remote IP
# matches the local IP (ie. you're connecting from the same computer), the
# connection is considered secure and plaintext authentication is allowed.
# See also ssl=required setting.

# í‰ë¬¸ ì¸ì¦ ë¹„í™œì„± ì˜µì…˜ ì„¤ì •
disable_plaintext_auth = no

# Authentication cache size (e.g. 10M). 0 means it's disabled. Note that
# bsdauth and PAM require cache_key to be set for caching to be used.
#auth_cache_size = 0
# Time to live for cached data. After TTL expires the cached record is no
# longer used, *except* if the main database lookup returns internal failure.
# We also try to handle password changes automatically: If user's previous
# authentication was successful, but this one wasn't, the cache isn't used.
# For now this works only with plaintext authentication.
#auth_cache_ttl = 1 hour
# TTL for negative hits (user not found, password mismatch).
# 0 disables caching them completely.
#auth_cache_negative_ttl = 1 hour

# Space separated list of realms for SASL authentication mechanisms that need
# them. You can leave it empty if you don't want to support multiple realms.
# Many clients simply use the first one listed here, so keep the default realm
# first.
#auth_realms =

# Default realm/domain to use if none was specified. This is used for both
# SASL realms and appending @domain to username in plaintext logins.
#auth_default_realm = 

# List of allowed characters in username. If the user-given username contains
# a character not listed in here, the login automatically fails. This is just
# an extra check to make sure user can't exploit any potential quote escaping
# vulnerabilities with SQL/LDAP databases. If you want to allow all characters,
# set this value to empty.
#auth_username_chars = abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ01234567890.-_@

# Username character translations before it's looked up from databases. The
# value contains series of from -> to characters. For example "#@/@" means
# that '#' and '/' characters are translated to '@'.
#auth_username_translation =

# Username formatting before it's looked up from databases. You can use
# the standard variables here, eg. %Lu would lowercase the username, %n would
# drop away the domain if it was given, or "%n-AT-%d" would change the '@' into
# "-AT-". This translation is done after auth_username_translation changes.
#auth_username_format = %Lu

# If you want to allow master users to log in by specifying the master
# username within the normal username string (ie. not using SASL mechanism's
# support for it), you can specify the separator character here. The format
# is then <username><separator><master username>. UW-IMAP uses "*" as the
# separator, so that could be a good choice.
#auth_master_user_separator =

# Username to use for users logging in with ANONYMOUS SASL mechanism
#auth_anonymous_username = anonymous

# Maximum number of dovecot-auth worker processes. They're used to execute
# blocking passdb and userdb queries (eg. MySQL and PAM). They're
# automatically created and destroyed as needed.
#auth_worker_max_count = 30

# Host name to use in GSSAPI principal names. The default is to use the
# name returned by gethostname(). Use "$ALL" (with quotes) to allow all keytab
# entries.
#auth_gssapi_hostname =

# Kerberos keytab to use for the GSSAPI mechanism. Will use the system
# default (usually /etc/krb5.keytab) if not specified. You may need to change
# the auth service to run as root to be able to read this file.
#auth_krb5_keytab = 

# Do NTLM and GSS-SPNEGO authentication using Samba's winbind daemon and
# ntlm_auth helper. <doc/wiki/Authentication/Mechanisms/Winbind.txt>
#auth_use_winbind = no

# Path for Samba's ntlm_auth helper binary.
#auth_winbind_helper_path = /usr/bin/ntlm_auth

# Time to delay before replying to failed authentications.
#auth_failure_delay = 2 secs

# Require a valid SSL client certificate or the authentication fails.
#auth_ssl_require_client_cert = no

# Take the username from client's SSL certificate, using 
# X509_NAME_get_text_by_NID() which returns the subject's DN's
# CommonName. 
#auth_ssl_username_from_cert = no

# Space separated list of wanted authentication mechanisms:
#   plain login digest-md5 cram-md5 ntlm rpa apop anonymous gssapi otp
#   gss-spnego
# NOTE: See also disable_plaintext_auth setting.

# IMAP ë¡œê·¸ì¸ í™œì„±í™”
auth_mechanisms = plain login

##
## Password and user databases
##

#
# Password database is used to verify user's password (and nothing more).
# You can have multiple passdbs and userdbs. This is useful if you want to
# allow both system users (/etc/passwd) and virtual users to login without
# duplicating the system users into virtual database.
#
# <doc/wiki/PasswordDatabase.txt>
#
# User database specifies where mails are located and what user/group IDs
# own them. For single-UID configuration use "static" userdb.
#
# <doc/wiki/UserDatabase.txt>

#!include auth-deny.conf.ext
#!include auth-master.conf.ext

!include auth-system.conf.ext
#!include auth-sql.conf.ext
#!include auth-ldap.conf.ext
#!include auth-passwdfile.conf.ext
#!include auth-checkpassword.conf.ext
#!include auth-static.conf.ext
```

`sudo vi /etc/dovecot/dovecot.conf` ê·¸ë¦¬ê³  ì´ íŒŒì¼ì˜ ê°€ì¥ í•˜ë‹¨ì—
```
protocols = pop3 imap
```
ë¥¼ ì¶”ê°€í•´ì¤ë‹ˆë‹¤.

`sudo vi /etc/dovecot/conf.d/10-mail.conf` ë©”ì¼ ì„¤ì • íŒŒì¼ì˜ 30ë²ˆì§¸ ì¤„ì„
```
mail_location = maildir:~/Maildir
```
ì™€ ê°™ì´ ìˆ˜ì •í•´ì¤ë‹ˆë‹¤.

`sudo vi /etc/dovecot/conf.d/10-ssl.conf` ssl ì„¤ì • íŒŒì¼ì€ ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •í•´ì¤ë‹ˆë‹¤.
```
##
## SSL settings
##

# SSL/TLS support: yes, no, required. <doc/wiki/SSL.txt>

# í™œì„±í™”
ssl = yes

# PEM encoded X.509 SSL/TLS certificate and private key. They're opened before
# dropping root privileges, so keep the key file unreadable by anyone but
# root. Included doc/mkcert.sh can be used to easily generate self-signed
# certificate, just make sure to update the domains in dovecot-openssl.cnf

# ì¸ì¦ì„œ ê²½ë¡œ
ssl_cert = </etc/letsencrypt/live/[yourdomain]/fullchain.pem
ssl_key = </etc/letsencrypt/live/[yourdomain]/privkey.pem

# If key file is password protected, give the password here. Alternatively
# give it when starting dovecot with -p parameter. Since this file is often
# world-readable, you may want to place this setting instead to a different
# root owned 0600 file by using ssl_key_password = <path.
#ssl_key_password =
```

`sudo vi /etc/dovecot/conf.d/20-pop3.conf` POP3 ì„¤ì • íŒŒì¼ì˜ 50ë²ˆì§¸ ì¤„ì„ ì£¼ì„ í•´ì œí•´ì¤ë‹ˆë‹¤.

```
pop3_uidl_format = %08Xu%08Xv
```

ì´ë ‡ê²Œ ì„¤ì •ì´ ëë‚¬ìŠµë‹ˆë‹¤.

postfixì™€ ë˜‘ê°™ì´ `systemctl restart dovecot`ë¡œ ì¬ì‹¤í–‰ ì‹œì¼œì¤ë‹ˆë‹¤.

### 4. ë©”ì¼ ì‚¬ìš©ì ê³„ì • ìƒì„± ğŸ™‹

ê³„ì • ìƒì„±ì„ í•  ê±´ë°, ê·¸ëƒ¥ ìœ ì €ë¥¼ ì¶”ê°€í•´ì£¼ë©´ ë©ë‹ˆë‹¤.

```
useradd [ê³„ì •ëª…]
usermod -G mail [ê³„ì •ëª…]
usermod -s /usr/sbin/nologin [ê³„ì •ëª…]
passwd [ê³„ì •ëª…]
```
ë¡œ ê³„ì •ì„ ìƒì„±í•©ë‹ˆë‹¤.

ì´ ë•Œ, í•´ë‹¹ ìœ ì €ëŠ” ë©”ì¼ ì„œë²„ë§Œ ì‚¬ìš©í•  ê²ƒì´ê¸° ë•Œë¬¸ì— nologin ì²˜ë¦¬ë¥¼ í•´ì„œ ê°€ë³¸ ì…¸ì„ ë¹„í™œì„±í™” í•´ì¤ë‹ˆë‹¤.

```
chown :mail /home
chmod 775 /home
```

ë§ˆì§€ë§‰ìœ¼ë¡œ ê¶Œí•œ ì„¤ì •ì„ í•´ì£¼ë©´ ê³„ì • ìƒì„±ì€ ëì…ë‹ˆë‹¤!

ì´ì œ ë©”ì¼ ì„œë²„ êµ¬ì¶•ì€ ëì…ë‹ˆë‹¤.

ë‹¤ìŒ í¬ìŠ¤íŠ¸ì—ì„œ ì§„í–‰í•  ë³´ì•ˆ ê³¼ì •ê¹Œì§€ ë§ˆë¬´ë¦¬í•˜ê³  ë‚˜ë©´ ë©”ì¼ì„ ììœ ë¡­ê²Œ ì†¡ìˆ˜ì‹  í•  ìˆ˜ ìˆì–´ìš”!!

## ì°¸ê³  ì‚¬ì´íŠ¸ ğŸ”
[Postfix, dovecot, letsencrypt ë¥¼ ì´ìš©í•œ ë©”ì¼ì„œë²„ êµ¬ì¶•](https://teem0.com/9)

ì´ ì‚¬ì´íŠ¸ê°€ ì—†ì—ˆë‹¤ë©´ ì €ëŠ” ë©”ì¼ ì„œë²„ë¥¼ êµ¬ì¶•í•  ìˆ˜ ì—†ì—ˆì„ ê±°ì˜ˆìš”...

[Ubuntu ê¸°ë°˜ Postfix ë©”ì¼ ì„œë²„ êµ¬ì¶• ë° Java ì—°ë™](https://valuableinfo.tistory.com/58)

ì—¬ê¸°ì„œëŠ” postfix êµ¬ì„± íŒŒì¼ ê´€ë ¨í•´ì„œ ì •ë³´ë¥¼ ë§ì´ ì–»ì—ˆìŠµë‹ˆë‹¤.

---
title:  "홈서버로 메일 서버 구축(2) - 메일 보안 (SPF, DKIM, DMARC)"
categories: 
  - archiving
tags:
  - homeserver
toc: true
toc_sticky: true
---

## 메일 보안을 적용 해봅시다 ✉️

지난 포스트에서는 메일 서버를 구축했습니다.

메일 서버만으로도 서버 내에서 메일을 송수신 할 수는 있지만, 서버 외부로는 메일을 송수신 하기가 어려워요.

Gmail이나 네이버 메일 등에서는 메일 인증이 올바르게 설정되지 않은 서버에서 보낸 메일을 스팸 처리하거나, 아예 수신을 거부하기도 합니다.

따라서 생성한 메일 계정을 외부에서도 자유롭게 사용하려면, SPF, DKIM, DMARC와 같은 메일 인증 표준을 적용해야 합니다.

## 선수 지식 🧐

### 1. SPF

SPF(Sender Policy Framework)는 수신 메일 서버에서 메일을 수신 받는 시점에 발신 메일 서버가 가리키는 IP 주소가 DNS 서버에 등록된 IP와 일치하는지 확인하는 절차입니다.

<figure class="align-center">
  <img src="/assets/images/mail_SPF.png" alt="SPF 인증 절차" width="98%">
  <figcaption class="img-source">
    이미지 출처: <a href="https://www.crinity.net/Newsletter/2019/06/Coffee_Break.html" target="_blank">https://www.crinity.net/Newsletter/2019/06/Coffee_Break.html</a>
  </figcaption>
</figure>

위의 그림을 보면 보다 쉽게 이해가 될텐데요, 발신 측은 미리 도메인 DNS에 TXT 레코드 형식으로 허용된 서버 IP를 등록해두고, 수신 측이 IP 주소를 확인할 때 DNS 서버를 통해 등록되어 있는 IP 주소와 동일한지 비교합니다.

이 과정을 통해 메일 서버 도메인을 사칭하지 않았는지 검증할 수 있어요.

하지만, SPF로는 완전히 발신 도메인 사칭을 방지할 수 없기 때문에 DKIM과 DMARC를 함께 사용해주어야 합니다.

### 2. DKIM

DKIM(Domain Keys Identified Mail)은 메일이 전송되는 과정 중에 변조되지 않았는지를 검증하는 절차입니다.

많은 사람들이 DKIM을 밀랍 봉인에 비유하곤 합니다.

DKIM의 절차는 다음과 같습니다.

<figure class="align-center">
  <img src="/assets/images/mail_DKIM.png" alt="DKIM 인증 절차" width="98%">
  <figcaption class="img-source">
    이미지 출처: <a href="https://www.crinity.net/Newsletter/2019/06/Coffee_Break.html" target="_blank">https://www.crinity.net/Newsletter/2019/06/Coffee_Break.html</a>
  </figcaption>
</figure>

DKIM은 공개키, 개인키의 개념이 사용되지만 어렵지 않습니다.

SPF에서는 IP 주소를 도메인 DNS에 등록해두었다면, DKIM에서는 공개키 정보를 TXT 레코드 형식으로 등록해두면 됩니다.

이후에, 메일 발송 시 DKIM-Signature에 개인키로 전자서명 후 헤더에 포함하여 전송하면, 수신 메일 서버에서 DNS에 등록되어 있는 레코드를 조회하여 검증합니다.

그러나, DKIM만으로는 From 변조를 검증할 수 없습니다.

DKIM은 도메인 검증만 하기 때문에, MAIL FROM과 from이 같은지 비교할 수 있도록 DMARC를 추가로 적용해주어야 합니다.

### 3. DMARC

DMARC(Domain-based Message Authentication Reporting Conformance)는 발신자 정보를 위조하는 것을 예방하기 위한 검증 방법입니다.

DMARC는 SPF와 DKIM에 Reporting이 합쳐져 있는데요, 아래가 DMARC의 절차입니다.

<figure class="align-center">
  <img src="/assets/images/mail_DMARC.png" alt="DMARC 인증 절차" width="98%">
  <figcaption class="img-source">
    이미지 출처: <a href="https://www.crinity.net/Newsletter/2019/06/Coffee_Break.html" target="_blank">https://www.crinity.net/Newsletter/2019/06/Coffee_Break.html</a>
  </figcaption>
</figure>

SPF와 DKIM을 둘 다 사용해서 메일 서버 도메인 사칭과 내용물 변조 여부를 검증합니다.

이후에 메일이 SPF, DKIM 인증 절차를 통과하지 못한다면 DMARC 정책이 적용되는데, 이 때 사용자가 설정한 정책에 따라 메일을 스팸 처리하거나 거부하고, 검증 결과를 보고서로 설정된 주소에 발송할 수 있습니다.

이 때 정책은 도메인 DNS에 TXT 레코드 형식으로 등록하면 됩니다.

## 0. PTR 레코드

자 이제 메일 보안을 적용하기에 앞서, 가장 먼저 해주어야 할 과정이 있습니다.

도메인과 IP를 연결할 때에는 IP 주소가 도메인을 가리킬 수 있도록 **A 레코드**를 추가해줬었습니다.

하지만, 메일과 같은 경우는 도메인이 어떤 IP 주소를 가리키고 있는지 확인이 필요합니다.

이 확인 과정을 역방향 DNS 조회, 혹은 리버스 DNS 조회라고 합니다.

PTR 레코드는 다음과 같이 추가하면 됩니다.

| Host                          | Type    |Priority     |TTL          |Data              |
|-------------------------------|---------|-------------|-------------|------------------|
| [**뒤집은 공인 IP**].in-addr.arpa| PTR     | N/A         | 4 hrs       |mail.[yourdomain] |

정말 정말 중요한 포인트는 공인 IP를 기입할 때 IP 주소를 뒤집어서 표기해야 합니다. 예를 들어 123.456.789.987 이라면, 987.789.456.123 이렇게 적어주어야 해요.

제가 정말 이것 때문에 고생했습니다. 그리고 생각 보다 많은 사람들이 이것 때문에 고생을 하더라구요.

이 내용은 아래 Squarespace 포럼에서 확인했습니다.

[Correct way to set PTR DNS record for mail forwarding](https://forum.squarespace.com/topic/300186-correct-way-to-set-ptr-dns-record-for-mail-forwarding/)

## 1. SPF 설정하기 🥸

자 그러면 SPF부터 설정을 해봅시다!

SPF를 위한 TXT 레코드 설정은 굉장히 간단합니다.

| Host      | Type    |Priority     |TTL          |Data             |
|-----------|---------|-------------|-------------|-----------------|
| @         | TXT     | N/A         | 4 hrs       |v=spf1 ip4:[공인 IP] ~all|

이렇게 설정해주면, 메일의 ip4가 설정한 IP와 동일한 경우 인증 절차를 통과 시켜줍니다.

그리고 저 같은 경우는 `~all` 옵션을 사용했기 때문에 SPF 검증에 실패한 경우에도 메일을 수락하지만, 수신 서버에서 ‘주의’ 또는 ‘스팸’으로 표시합니다.

인증 실패 시 메일을 완전히 차단하고 싶다면 `-all` 옵션을 사용하면 됩니다!

## 2. DKIM 설정하기 📦


